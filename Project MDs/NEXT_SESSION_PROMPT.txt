IMPLEMENTATION PROMPT - Hard Refresh SSE Race Condition Fix
================================================================

READ THE FULL IMPLEMENTATION PLAN FIRST:
Project MDs/2026-01-01-hard-refresh-sse-race-condition-fix.md

CONTEXT SUMMARY:
----------------
We have a race condition on hard refresh where SSE attempts to connect with a stale patient ID before localStorage is cleared, causing CORS/404 errors.

ROOT CAUSE:
- Hard refresh clears localStorage but SSE hook mounts with OLD patient ID from React state
- SSE connects to non-existent patient â†’ backend returns 404 â†’ browser shows "CORS error"
- Current code redirects to home page, but user wants to stay on current page

THE FIX:
--------
Implement the 4-phase plan in the full document:

Phase 1: Fix SSE Patient ID Reactivity
  - File: frontend/hooks/use-pipeline-events.ts
  - Make SSE hook detect patient ID changes and disconnect/reconnect properly
  - Add better error handling to distinguish 404 from CORS/network errors

Phase 2: Remove Hard Refresh Redirect
  - File: frontend/app/sessions/page.tsx
  - Remove router.push('/') redirect on hard refresh
  - Keep user on current page, handle reinitialization in-place

  - File: frontend/app/patient/components/WaveCompletionBridge.tsx
  - Auto-trigger demo initialization if patient ID missing for >5 seconds
  - Increase timeout to 120 seconds (demo init takes 30-90s)

Phase 3: Enhanced SSE Error Handling
  - File: frontend/hooks/use-pipeline-events.ts (additional improvements)
  - Add errorType return value ('patient_not_found' | 'network' | 'cors' | 'unknown')
  - Add grouped console logging for easier debugging

  - File: frontend/app/patient/components/WaveCompletionBridge.tsx
  - Add useEffect to log SSE error state changes

Phase 4: Remove /auth/login Redirects
  - File: frontend/lib/api-client.ts
  - Remove all window.location.href = '/auth/login' redirects (3 places)
  - Replace with demo token clearing and console logging
  - Let React components handle missing auth naturally

INSTRUCTIONS:
-------------
1. Read the FULL implementation plan first
2. Implement each phase in order
3. Test each phase before moving to the next
4. Follow the exact code changes specified in the plan
5. Create git commits using the backdating rules in .claude/CLAUDE.md

CRITICAL RULES FROM .claude/CLAUDE.md:
--------------------------------------
- ALWAYS check last commit timestamp: git log --format="%ci" -n 1
- Add exactly 30 seconds to that timestamp for next commit
- Use GIT_COMMITTER_DATE and --date flags with calculated timestamp
- Email: rohin.agrawal@gmail.com
- Username: newdldewdl
- All commits must be on December 23, 2025 (no commits after 11:45 PM)

SUCCESS CRITERIA:
-----------------
After implementation, these should work:

âœ… Hard refresh (Cmd+Shift+R) on /sessions:
   - Clears localStorage
   - Stays on /sessions (no redirect)
   - Auto-initializes new demo
   - SSE connects to NEW patient ID
   - No "CORS request did not succeed" errors

âœ… Simple refresh (Cmd+R):
   - Preserves localStorage
   - SSE reconnects automatically
   - Same patient ID maintained

âœ… Direct navigation to /sessions with no patient ID:
   - Auto-triggers demo initialization
   - Sessions load after init complete

âœ… SSE error handling:
   - Distinguishes 404 from network errors
   - Clear, actionable error messages
   - No spam in console

âœ… No redirects to /auth/login (page doesn't exist)

TESTING CHECKLIST:
------------------
Run all 6 manual tests from the plan:
- [ ] Test 1: Simple Refresh (Cmd+R)
- [ ] Test 2: Hard Refresh (Cmd+Shift+R) on Sessions Page
- [ ] Test 3: Hard Refresh on Home Page
- [ ] Test 4: Direct Navigation to Sessions (No Patient ID)
- [ ] Test 5: SSE Error Handling (Patient Not Found)
- [ ] Test 6: Network Failure Handling

AUTOMATED CHECKS:
-----------------
- [ ] TypeScript builds: cd frontend && npm run build
- [ ] ESLint passes: cd frontend && npm run lint
- [ ] No console errors on page load

FILES TO MODIFY:
----------------
1. frontend/hooks/use-pipeline-events.ts (Phase 1 & 3)
2. frontend/app/sessions/page.tsx (Phase 2)
3. frontend/app/patient/components/WaveCompletionBridge.tsx (Phase 2 & 3)
4. frontend/lib/api-client.ts (Phase 4)

BACKUP FIRST:
-------------
Before making ANY changes:
1. git status
2. git add -A
3. git commit -m "Backup before SSE race condition fix"
4. git push

Then proceed with implementation.

DEPLOYMENT:
-----------
After all phases complete and tested:
1. Build: cd frontend && npm run build
2. Commit with backdated timestamp
3. Push to git (Railway auto-deploys)
4. Monitor Railway logs for any issues

QUESTIONS FOR ME:
-----------------
If you encounter any issues or need clarification:
- The full plan has detailed code snippets for every change
- The plan explains WHY each change is needed
- Test after each phase to isolate any problems

Good luck! ðŸš€
