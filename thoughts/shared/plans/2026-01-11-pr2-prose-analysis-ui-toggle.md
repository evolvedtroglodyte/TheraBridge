# PR #2: Prose Analysis UI with Toggle - Implementation Plan

**Created:** 2026-01-11
**Status:** Planning Phase
**Depends on:** PR #1 (Complete âœ…)
**Complexity:** Medium (Frontend-focused with localStorage persistence)

---

## Overview

Add a tab toggle in SessionDetail to switch between:
1. **Structured Analysis View** (Current default) - Card-based UI with DeepAnalysisSection
2. **Prose Narrative View** (NEW) - Flowing prose text generated by Wave 2 analysis

**Design Goals:**
- Unified color palette matching dashboard (teal/purple theme switching)
- Default to Prose view (more accessible for patients)
- localStorage persistence (remembers user preference across sessions)
- Smooth transitions with Framer Motion
- Dark mode support
- Accessible tab navigation (keyboard support, ARIA labels)

---

## Current State Analysis

### Data Already Available âœ…
- `Session.prose_analysis` (string) - Generated by Wave 2 backend
- `Session.deep_analysis` (DeepAnalysis object) - Structured JSONB data
- `Session.prose_generated_at` (ISO timestamp) - Generation timestamp

### Current UI Structure
**File:** `frontend/app/patient/components/SessionDetail.tsx`

**Layout:**
- Two-column fullscreen modal (transcript left, analysis right)
- Analysis column currently shows:
  1. Metadata (duration, mood score)
  2. Topics Discussed
  3. Strategy Used (with technique definition)
  4. Action Items
  5. Session Summary (Wave 1 ultra-brief)
  6. Milestone (if present)
  7. **DeepAnalysisSection** (structured cards) - Lines 365-372

**Current Deep Analysis Rendering:**
```tsx
{/* Deep Clinical Analysis */}
{session.deep_analysis && (
  <div className="mt-6 p-4 bg-[#5AB9B4]/5 dark:bg-[#a78bfa]/10 rounded-xl border border-[#5AB9B4]/20 dark:border-[#a78bfa]/30">
    <DeepAnalysisSection
      analysis={session.deep_analysis}
      confidence={session.analysis_confidence || 0.8}
    />
  </div>
)}
```

### Typography Standards
```tsx
const TYPOGRAPHY = {
  serif: '"Crimson Pro", Georgia, serif',  // Body text, narrative content
  sans: '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',  // Headers, labels
} as const;
```

---

## Implementation Plan

### Phase 1: Add Tab Toggle UI Component

**File:** `frontend/app/patient/components/SessionDetail.tsx`

#### 1.1 Add State Management
**Location:** After theme state (lines ~80-90)

```tsx
// Theme toggle state (existing)
const { theme, setTheme } = useTheme();
const [mounted, setMounted] = useState(false);

// NEW: Analysis view toggle state
type AnalysisView = 'prose' | 'structured';
const [analysisView, setAnalysisView] = useState<AnalysisView>('prose');

// NEW: Load preference from localStorage on mount
useEffect(() => {
  const savedView = localStorage.getItem('therabridge_analysis_view') as AnalysisView | null;
  if (savedView === 'prose' || savedView === 'structured') {
    setAnalysisView(savedView);
  }
}, []);

// NEW: Save preference to localStorage when changed
useEffect(() => {
  localStorage.setItem('therabridge_analysis_view', analysisView);
}, [analysisView]);
```

#### 1.2 Create TabToggle Component
**Location:** Before SessionDetailProps interface (lines ~65-70)

```tsx
interface TabToggleProps {
  activeView: AnalysisView;
  onViewChange: (view: AnalysisView) => void;
  hasProse: boolean;
  hasStructured: boolean;
}

function TabToggle({ activeView, onViewChange, hasProse, hasStructured }: TabToggleProps) {
  const { isDark } = useTheme();

  // Color palette (matching dashboard theme)
  const activeColor = isDark ? '#a78bfa' : '#5AB9B4'; // Purple (dark) / Teal (light)
  const inactiveColor = isDark ? '#64748b' : '#94a3b8'; // Slate gray
  const activeBg = isDark ? 'rgba(167, 139, 250, 0.15)' : 'rgba(90, 185, 180, 0.15)';

  return (
    <div
      className="flex items-center gap-2 mb-6 p-1 bg-gray-100 dark:bg-[#1a1625] rounded-lg border border-gray-200 dark:border-[#3d3548]"
      role="tablist"
      aria-label="Analysis view selector"
    >
      {/* Prose Tab */}
      <button
        role="tab"
        aria-selected={activeView === 'prose'}
        aria-controls="prose-panel"
        disabled={!hasProse}
        onClick={() => onViewChange('prose')}
        className={`
          flex-1 px-4 py-2.5 rounded-md transition-all duration-200
          ${activeView === 'prose' ? 'shadow-sm' : 'opacity-60 hover:opacity-80'}
          ${!hasProse && 'cursor-not-allowed opacity-40'}
        `}
        style={{
          backgroundColor: activeView === 'prose' ? activeBg : 'transparent',
          fontFamily: TYPOGRAPHY.sans,
          fontSize: '13px',
          fontWeight: activeView === 'prose' ? 600 : 500,
          color: activeView === 'prose' ? activeColor : inactiveColor,
        }}
      >
        ðŸ“– Narrative
      </button>

      {/* Structured Tab */}
      <button
        role="tab"
        aria-selected={activeView === 'structured'}
        aria-controls="structured-panel"
        disabled={!hasStructured}
        onClick={() => onViewChange('structured')}
        className={`
          flex-1 px-4 py-2.5 rounded-md transition-all duration-200
          ${activeView === 'structured' ? 'shadow-sm' : 'opacity-60 hover:opacity-80'}
          ${!hasStructured && 'cursor-not-allowed opacity-40'}
        `}
        style={{
          backgroundColor: activeView === 'structured' ? activeBg : 'transparent',
          fontFamily: TYPOGRAPHY.sans,
          fontSize: '13px',
          fontWeight: activeView === 'structured' ? 600 : 500,
          color: activeView === 'structured' ? activeColor : inactiveColor,
        }}
      >
        ðŸ“Š Structured
      </button>
    </div>
  );
}
```

**Design Notes:**
- Emoji icons (ðŸ“– = book for narrative, ðŸ“Š = chart for structured)
- Disabled state when data not available
- ARIA attributes for accessibility
- Smooth color transitions
- Inline styles for dynamic theme colors

#### 1.3 Create ProseAnalysisView Component
**Location:** After TabToggle component

```tsx
interface ProseAnalysisViewProps {
  prose: string;
  generatedAt?: string;
  confidence: number;
}

function ProseAnalysisView({ prose, generatedAt, confidence }: ProseAnalysisViewProps) {
  const { isDark } = useTheme();

  return (
    <div
      role="tabpanel"
      id="prose-panel"
      aria-labelledby="prose-tab"
      className="animate-fadeIn"
    >
      {/* Header with Dobby logo */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 flex items-center justify-center">
            <DobbyLogo size={40} />
          </div>
          <div>
            <h3 style={{ fontFamily: TYPOGRAPHY.sans, fontSize: '20px', fontWeight: 600 }} className="text-gray-800 dark:text-gray-200">
              Clinical Narrative
            </h3>
            <p style={{ fontFamily: TYPOGRAPHY.sans, fontSize: '11px' }} className="text-gray-500 dark:text-gray-400">
              AI-powered analysis â€¢ {Math.round(confidence * 100)}% confidence
            </p>
          </div>
        </div>
      </div>

      {/* Prose content */}
      <div className="prose-container p-6 bg-white dark:bg-[#1a1625] rounded-xl border border-gray-200 dark:border-[#3d3548]">
        {/* Split prose into paragraphs for better readability */}
        {prose.split('\n\n').map((paragraph, idx) => (
          <p
            key={idx}
            style={{
              fontFamily: TYPOGRAPHY.serif,
              fontSize: '15px',
              fontWeight: 400,
              lineHeight: 1.8,
              marginBottom: idx < prose.split('\n\n').length - 1 ? '16px' : '0'
            }}
            className="text-gray-700 dark:text-gray-300"
          >
            {paragraph}
          </p>
        ))}
      </div>

      {/* Timestamp footer */}
      {generatedAt && (
        <p style={{ fontFamily: TYPOGRAPHY.sans, fontSize: '11px' }} className="text-gray-400 dark:text-gray-500 mt-3 text-right">
          Generated {new Date(generatedAt).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })}
        </p>
      )}
    </div>
  );
}
```

**Design Notes:**
- Same header style as DeepAnalysisSection (Dobby logo + confidence)
- Paragraph splitting for multi-paragraph prose
- Crimson Pro serif font for narrative readability
- Line height 1.8 for comfortable reading
- Timestamp footer for transparency

---

### Phase 2: Integrate Toggle into SessionDetail

**File:** `frontend/app/patient/components/SessionDetail.tsx`

#### 2.1 Import DobbyLogo Component
**Location:** Top of file (line ~18)

```tsx
import { DeepAnalysisSection } from './DeepAnalysisSection';
import { DobbyLogo } from './DobbyLogo'; // ADD THIS
import { LoadingOverlay } from './LoadingOverlay';
```

#### 2.2 Replace Deep Analysis Section
**Location:** Lines 364-372 (current deep_analysis rendering)

**Before:**
```tsx
{/* Deep Clinical Analysis */}
{session.deep_analysis && (
  <div className="mt-6 p-4 bg-[#5AB9B4]/5 dark:bg-[#a78bfa]/10 rounded-xl border border-[#5AB9B4]/20 dark:border-[#a78bfa]/30">
    <DeepAnalysisSection
      analysis={session.deep_analysis}
      confidence={session.analysis_confidence || 0.8}
    />
  </div>
)}
```

**After:**
```tsx
{/* Analysis Section with Toggle */}
{(session.prose_analysis || session.deep_analysis) && (
  <div className="mt-6">
    {/* Tab Toggle */}
    <TabToggle
      activeView={analysisView}
      onViewChange={setAnalysisView}
      hasProse={!!session.prose_analysis}
      hasStructured={!!session.deep_analysis}
    />

    {/* Prose View */}
    {analysisView === 'prose' && session.prose_analysis && (
      <motion.div
        key="prose"
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -10 }}
        transition={{ duration: 0.2 }}
      >
        <ProseAnalysisView
          prose={session.prose_analysis}
          generatedAt={session.prose_generated_at}
          confidence={session.analysis_confidence || 0.8}
        />
      </motion.div>
    )}

    {/* Structured View */}
    {analysisView === 'structured' && session.deep_analysis && (
      <motion.div
        key="structured"
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -10 }}
        transition={{ duration: 0.2 }}
      >
        <div className="p-4 bg-[#5AB9B4]/5 dark:bg-[#a78bfa]/10 rounded-xl border border-[#5AB9B4]/20 dark:border-[#a78bfa]/30">
          <DeepAnalysisSection
            analysis={session.deep_analysis}
            confidence={session.analysis_confidence || 0.8}
          />
        </div>
      </motion.div>
    )}

    {/* Fallback: No analysis available */}
    {analysisView === 'prose' && !session.prose_analysis && (
      <div className="p-6 bg-gray-50 dark:bg-[#1a1625] rounded-xl border border-gray-200 dark:border-[#3d3548] text-center">
        <p style={{ fontFamily: TYPOGRAPHY.serif, fontSize: '14px', fontStyle: 'italic' }} className="text-gray-500 dark:text-gray-500">
          Narrative analysis not yet available for this session.
        </p>
      </div>
    )}

    {analysisView === 'structured' && !session.deep_analysis && (
      <div className="p-6 bg-gray-50 dark:bg-[#1a1625] rounded-xl border border-gray-200 dark:border-[#3d3548] text-center">
        <p style={{ fontFamily: TYPOGRAPHY.serif, fontSize: '14px', fontStyle: 'italic' }} className="text-gray-500 dark:text-gray-500">
          Structured analysis not yet available for this session.
        </p>
      </div>
    )}
  </div>
)}
```

**Changes:**
- Conditional rendering: Show toggle only if EITHER prose OR structured exists
- Framer Motion transitions (fade + slide up/down)
- Fallback messages for missing data
- Preserved bg color wrapper for structured view

---

### Phase 3: Add Tailwind Animation

**File:** `frontend/tailwind.config.ts`

#### 3.1 Add Fade-In Animation
**Location:** `theme.extend.animation` section

```ts
module.exports = {
  theme: {
    extend: {
      animation: {
        fadeIn: 'fadeIn 0.2s ease-in',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
      },
    },
  },
}
```

---

### Phase 4: Testing & Validation

#### 4.1 Manual Testing Checklist
- [ ] **Tab Toggle Functionality**
  - [ ] Click "Narrative" tab â†’ Shows prose analysis
  - [ ] Click "Structured" tab â†’ Shows DeepAnalysisSection cards
  - [ ] Transitions are smooth (fade + slide animation)
  - [ ] Active tab has correct color (teal in light, purple in dark)

- [ ] **localStorage Persistence**
  - [ ] Set view to "Narrative", refresh page â†’ Stays on Narrative
  - [ ] Set view to "Structured", refresh page â†’ Stays on Structured
  - [ ] Open different session â†’ Remembers preference

- [ ] **Dark Mode**
  - [ ] Toggle theme â†’ Tab colors switch correctly (teal â†’ purple)
  - [ ] Prose text readable in dark mode
  - [ ] Background colors match theme

- [ ] **Data Availability**
  - [ ] Session with ONLY prose_analysis â†’ Structured tab disabled
  - [ ] Session with ONLY deep_analysis â†’ Narrative tab disabled
  - [ ] Session with BOTH â†’ Both tabs enabled
  - [ ] Session with NEITHER â†’ No toggle shown (current behavior)

- [ ] **Accessibility**
  - [ ] Tab key navigation works
  - [ ] Screen reader announces active tab
  - [ ] Disabled tabs have `aria-disabled="true"`

- [ ] **Typography**
  - [ ] Prose uses Crimson Pro serif font
  - [ ] Tab labels use Inter sans font
  - [ ] Fonts match SessionDetail standards

#### 4.2 Browser Testing
- [ ] Chrome (latest)
- [ ] Safari (macOS)
- [ ] Firefox (latest)

#### 4.3 Regression Testing
- [ ] SessionDetail still opens/closes correctly
- [ ] Transcript viewer still works
- [ ] Scroll preservation still functions
- [ ] Loading overlay still appears
- [ ] X button still closes modal
- [ ] Theme toggle still works

---

## File Manifest

### Modified Files (1)
1. **`frontend/app/patient/components/SessionDetail.tsx`**
   - Add `AnalysisView` type (prose | structured)
   - Add state management (analysisView, localStorage persistence)
   - Add `TabToggle` component (~70 lines)
   - Add `ProseAnalysisView` component (~60 lines)
   - Replace deep_analysis rendering (lines 364-372) with toggle logic
   - Import `DobbyLogo` component

### Modified Files (1) - Optional CSS
2. **`frontend/tailwind.config.ts`** (Optional - Framer Motion handles animations)
   - Add `fadeIn` animation to `theme.extend.animation`

### No New Files
- All components inline in SessionDetail.tsx (keeps complexity low)

---

## Rollback Plan

### If Issues Found
1. **Revert SessionDetail.tsx** to commit before PR #2
2. **Clear localStorage** (optional): `localStorage.removeItem('therabridge_analysis_view')`
3. **No database changes** - This is frontend-only

### Git Commands
```bash
# Revert to commit before PR #2
git log --oneline -5  # Find commit hash before PR #2
git revert <commit-hash>

# Or reset (dangerous)
git reset --hard <commit-hash-before-pr2>
```

---

## Cost Impact

**Zero cost increase** - No new LLM calls, no backend changes. Only frontend UI reorganization.

---

## Timeline Estimate

**Implementation:** 1-2 hours
- Phase 1 (Tab UI): 30 min
- Phase 2 (Integration): 30 min
- Phase 3 (CSS): 5 min
- Phase 4 (Testing): 30-60 min

**Total:** ~2 hours for full implementation + testing

---

## Dependencies

### Completed
- âœ… PR #1 (SessionDetail font standardization)
- âœ… Wave 2 backend (prose_analysis generation)
- âœ… Frontend Session type (includes prose_analysis field)

### Required Packages (Already Installed)
- âœ… Framer Motion (for animations)
- âœ… next-themes (for theme detection)
- âœ… Tailwind CSS (for styling)

---

## Success Criteria

- [ ] Tab toggle renders correctly in SessionDetail
- [ ] Prose view displays narrative analysis (Crimson Pro serif)
- [ ] Structured view displays DeepAnalysisSection cards (unchanged)
- [ ] localStorage persists user preference across sessions
- [ ] Smooth transitions between views (Framer Motion)
- [ ] Dark mode colors match dashboard theme (teal â†’ purple)
- [ ] Accessibility: keyboard navigation + ARIA labels
- [ ] Disabled tabs when data unavailable
- [ ] No regressions in existing SessionDetail functionality
- [ ] Build compiles without TypeScript errors

---

## Open Questions

### Q1: Should we add a loading state for analysis data?
**Answer:** Not necessary - SessionDetail already has `LoadingOverlay` that covers the entire modal during data fetching.

### Q2: Should prose text support markdown formatting?
**Answer:** Not in Phase 1. Backend currently returns plain text prose. If GPT-5 starts generating markdown (headers, lists, bold), we can add a markdown renderer in Phase 2.

### Q3: What if session has partial data (e.g., prose exists but empty string)?
**Answer:** Treat empty strings as missing data. Check `!!session.prose_analysis` (falsy for empty strings).

---

## Notes for Implementation

1. **Default to Prose**: User research suggests patients prefer narrative over structured cards. Default `analysisView = 'prose'` unless localStorage overrides.

2. **Smooth Transitions**: Use Framer Motion's `motion.div` with `initial`, `animate`, `exit` for professional fade + slide effect.

3. **Color Palette Consistency**: Match dashboard theme switching:
   - Light mode: Teal (#5AB9B4) for primary, Purple (#B8A5D6) for secondary
   - Dark mode: Purple (#a78bfa) for primary, Blue accents

4. **Typography Hierarchy**:
   - Tab labels: Inter sans, 13px, weight 500/600
   - Prose text: Crimson Pro serif, 15px, weight 400, line-height 1.8
   - Timestamps: Inter sans, 11px

5. **Accessibility First**:
   - Use semantic `<button role="tab">` elements
   - ARIA labels (`aria-selected`, `aria-controls`, `aria-labelledby`)
   - Keyboard navigation (Tab, Enter, Arrow keys)

---

## Future Enhancements (Not in Scope)

- [ ] Print-friendly prose view
- [ ] Export to PDF functionality
- [ ] Markdown rendering support
- [ ] Highlighting key insights in prose
- [ ] Compare prose vs structured side-by-side
- [ ] User feedback on analysis quality

---

**Plan Status:** âœ… Complete - Ready for Implementation

**Next Step:** Execute implementation in separate Claude window (full-stack development mode)
